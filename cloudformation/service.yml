Description: Raiinmaker Service

Parameters:
  Stage:
    Type: String
    Default: "staging"

  hostedZoneId:
    Type: "String"
    Default: "Z2ADV4KXMZWAVJ"

  sslCertificateArn:
    Type: "String"
    Description: "Arn for the SSL cert to attach, defaults to *.api.dragonchain.com cert"
    Default: " arn:aws:acm:us-east-1:381978683274:certificate/c319f9d0-e6f2-49cc-93d6-0789cc886011"

Conditions:
  isProd:
    Fn::Equals:
      - Ref: Stage
      - "production"

Resources:
    raiinmakerRoute53:
      Type: AWS::Route53::RecordSet
      Properties:
        HostedZoneId: Z2ADV4KXMZWAVJ
        Name:
          Fn::If:
            - isProd
            - raiinmaker.api.dragonchain.com
            - Fn::Join:
                - ''
                - - raiinmaker-
                  - Ref: Stage
                  - .api.dragonchain.com
        Type: CNAME
        ResourceRecords:
          - Fn::If:
              - isProd
              - "uw2-k8s-internal.api.dragonchain.com"
              - "uw2-k8s-internal-stage.api.dragonchain.com"
        TTL: "300"

    BucketRoute53Configurations:
      Type: AWS::Route53::RecordSet
      Properties:
        AliasTarget:
          HostedZoneId: Z2FDTNDATAQYW2
          DNSName:
            Fn::GetAtt:
              - BucketCloudFrontDistribution
              - DomainName
        HostedZoneId:
          Ref: hostedZoneId
        Name:
          Fn::If:
            - isProd
            - "raiinmaker-media.api.dragonchain.com"
            - Fn::Join:
              - ""
              - - raiinmaker-media-
                - Ref: Stage
                - .api.dragonchain.com
        Type: A


    raiinmakerMediaOriginAccessIdentity:
      Type: AWS::CloudFront::CloudFrontOriginAccessIdentity
      Properties:
        CloudFrontOriginAccessIdentityConfig:
          Comment: S3 Raiinmaker Media Origin Access Identity

    BucketCloudFrontDistribution:
      Type: AWS::CloudFront::Distribution
      Properties:
        DistributionConfig:
          Aliases:
            - Fn::If:
              - isProd
              - "raiinmaker-media.api.dragonchain.com"
              - Fn::Join:
                  - ""
                  - - raiinmaker-media-
                    - Ref: Stage
                    - .api.dragonchain.com
          Enabled: true
          Origins:
            - DomainName:
                Fn::GetAtt:
                  - raiinmakerS3Bucket
                  - DomainName
              Id: origin
              S3OriginConfig:
                OriginAccessIdentity:
                  Fn::Join:
                    - '/'
                    - - origin-access-identity/cloudfront
                      - Ref: raiinmakerMediaOriginAccessIdentity
          DefaultCacheBehavior:
            TargetOriginId: origin
            DefaultTTL: 1440 # 1 day in minutes before cache clears
            ForwardedValues:
              QueryString: false
            ViewerProtocolPolicy: redirect-to-https
            Compress: true
            SmoothStreaming: true
          ViewerCertificate:
            AcmCertificateArn:
              Ref: sslCertificateArn
            SslSupportMethod: sni-only

    raiinmakerS3Bucket:
      Type: AWS::S3::Bucket
      Properties:
        BucketName:
          Fn::Join:
            - ''
            - - raiinmaker-
              - Ref: Stage

    raiinmakerKycKmsKey:
      Type: AWS::KMS::Key
      Properties:
        Description: Used for managing kyc
        Enabled: true
        PendingWindowInDays: 7
        Tags:
          - Key: Name
            Value:
              Fn::Join:
                - ''
                - - raiinmaker-kyc-
                  - Ref: Stage

    raiinmakerKycBucket:
      Type: AWS::S3::Bucket
      Properties:
        BucketEncryption:
          ServerSideEncryptionConfiguration:
            - ServerSideEncryptionByDefault:
                KMSMasterKeyID:
                  Ref: raiinmakerKycKmsKey
                SSEAlgorithm: aws:kms
        BucketName:
          Fn::Join:
            - ''
            - - raiinmaker-kyc-
              - Ref: Stage

    raiinmakerMediaBucketPolicy:
      Type: AWS::S3::BucketPolicy
      Properties:
        Bucket:
          Ref: raiinmakerS3Bucket
        PolicyDocument:
          Statement:
            - Effect: Allow
              Action:
                - "s3:GetObject"
              Principal:
                CanonicalUser:
                  Fn::GetAtt: [raiinmakerMediaOriginAccessIdentity, S3CanonicalUserId]
              Resource:
                Fn::Join:
                  - "/"
                  - - Fn::GetAtt: [raiinmakerS3Bucket, Arn]
                    - "*"

    raiinmakerServiceRole:
      Type: AWS::IAM::Role
      Properties:
        AssumeRolePolicyDocument:
          Statement:
            - Effect: Allow
              Action: sts:AssumeRole
              Principal:
                AWS:
                  Fn::If:
                    - isProd
                    - arn:aws:iam::381978683274:role/masters.uw2-k8s-internal.api.dragonchain.com
                    - arn:aws:iam::381978683274:role/masters.uw2-k8s-internal-stage.api.dragonchain.com
        RoleName:
          Fn::Join:
            - "-"
            - - "raiinmaker"
              - Ref: Stage

    raiinmakerServicePolicy:
      Type: AWS::IAM::Policy
      Properties:
        PolicyName:
          Fn::Join:
            - "-"
            - - raiinmaker-service-policy
              - Ref: Stage
        Roles:
          - Ref: raiinmakerServiceRole
        PolicyDocument:
          Version : "2012-10-17"
          Statement:
            - Effect: Allow
              Action: ["kms:*"]
              Resource:
                - Fn::GetAtt: [raiinmakerKycKmsKey, Arn]
            - Effect: Allow
              Action: ["logs:GetLogEvents"]
              Resource:
                - arn:aws:logs:us-west-2:381978683274:log-group:/k8s/openfaas-stage:*
                - arn:aws:logs:us-west-2:381978683274:log-group:/k8s/openfaas-prod:*
            - Effect: Allow
              Action: ["SNS:Publish"]
              Resource:
                Fn::If:
                  - isProd
                  - arn:aws:sns:us-west-2:381978683274:ers-production-Topic-LP3TJOCU3EWE
                  - arn:aws:sns:us-west-2:381978683274:ers-staging-Topic-SVYROUMXZY3V
            - Effect: Allow
              Action:
                - s3:*
              Resource:
                - Fn::GetAtt: [raiinmakerS3Bucket, Arn]
                - Fn::Join:
                  - ''
                  - - Fn::GetAtt: [raiinmakerS3Bucket, Arn]
                    - '/*'
                - Fn::GetAtt: [raiinmakerKycBucket, Arn]
                - Fn::Join:
                  - ''
                  - - Fn::GetAtt: [raiinmakerKycBucket, Arn]
                    - '/*'
